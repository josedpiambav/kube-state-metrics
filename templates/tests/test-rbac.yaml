{{- if and .Values.testFramework.enabled .Values.rbac.create }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "kube-state-metrics.fullname" . }}-test-rbac"
  labels:
    {{- include "kube-state-metrics.labels" . | nindent 4 }}
    app.kubernetes.io/name: {{ include "kube-state-metrics.name" . }}-
  annotations:
    "helm.sh/hook-weight": "3"
    {{- with .Values.testFramework.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  serviceAccountName: {{ include "kube-state-metrics.serviceAccountName" . }}
  containers:
  - name: test-rbac
    image: busybox
    command:
      - /bin/sh
      - -c
      - |
        set -ex
        echo "Testing RBAC permissions..."

        # Test if we can list pods (basic Kubernetes API access)
        if timeout 10 sh -c 'until kubectl get pods -n {{ .Release.Namespace }} --field-selector=status.phase=Running | grep -q "kube-state-metrics"; do sleep 1; done'; then
          echo "✅ Can access Kubernetes API and see kube-state-metrics pods"
        else
          echo "❌ Cannot access Kubernetes API or cannot find kube-state-metrics pods"
          exit 1
        fi

        # Test if we can list nodes
        if kubectl get nodes --request-timeout=5s > /dev/null 2>&1; then
          echo "✅ Can list cluster nodes"
        else
          echo "❌ Cannot list cluster nodes - RBAC issue?"
          exit 1
        fi

        echo "✅ RBAC tests passed!"
  restartPolicy: Never
{{- end }}