{{- if .Values.testFramework.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "kube-state-metrics.fullname" . }}-test-health"
  labels:
    {{- include "kube-state-metrics.labels" . | nindent 4 }}
    app.kubernetes.io/name: {{ include "kube-state-metrics.name" . }}-test
  annotations:
    "helm.sh/hook-weight": "1"
    {{- with .Values.testFramework.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  containers:
  - name: test-health
    image: busybox
    command:
      - /bin/sh
      - -c
      - |
        set -ex
        echo "Testing health endpoints..."

        # Test liveness endpoint
        if wget -q -O- -T 5 http://{{ include "kube-state-metrics.fullname" . }}:{{ .Values.service.port }}/livez | grep -q "ok"; then
          echo "✅ Liveness endpoint is healthy"
        else
          echo "❌ Liveness endpoint not responding correctly"
          exit 1
        fi

        # Test readiness endpoint  
        if wget -q -O- -T 5 http://{{ include "kube-state-metrics.fullname" . }}:{{ .Values.service.port }}/readyz | grep -q "ok"; then
          echo "✅ Readiness endpoint is healthy"
        else
          echo "❌ Readiness endpoint not responding correctly"
          exit 1
        fi

        # Test healthz endpoint
        if wget -q -O- -T 5 http://{{ include "kube-state-metrics.fullname" . }}:{{ .Values.service.port }}/healthz | grep -q "ok"; then
          echo "✅ Health endpoint is healthy"
        else
          echo "❌ Health endpoint not responding correctly"
          exit 1
        fi

        echo "✅ All health checks passed!"
  restartPolicy: Never
{{- end }}